<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nails Pro - Agendamento v2.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <style>
        /* --- VARIÁVEIS --- */
        :root {
            --primary: #E91E63;
            --primary-light: #FCE4EC;
            --status-avail: #10B981;
            --status-busy: #EF4444;
            --status-part: #F59E0B;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --bg-body: #F9FAFB;
            --bg-card: #FFFFFF;
            --border: #E5E7EB;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 90px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- STEPPER --- */
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .stepper::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #E5E7EB;
            z-index: 0;
        }

        .step {
            position: relative;
            z-index: 1;
            background: var(--bg-body);
            padding: 0 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #D1D5DB;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            transition: 0.3s;
        }

        .step-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .step.active .step-circle {
            background: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .step.completed .step-circle {
            background: var(--status-avail);
        }

        /* --- CARDS GENÉRICOS --- */
        .selection-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .card-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .item-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
        }

        .item-info h3 {
            font-size: 15px;
            font-weight: 600;
        }

        .item-info p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .price-tag {
            font-weight: 700;
            color: var(--primary);
        }

        /* --- CHECKBOX E QTD CONTROLS --- */
        .checkbox-circle {
            width: 24px;
            height: 24px;
            border: 2px solid #D1D5DB;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: 0.2s;
        }

        .card-item.selected .checkbox-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Estilos do Seletor de Quantidade */
        .qty-control {
            display: none;
            align-items: center;
            gap: 8px;
            background: white;
            border-radius: 20px;
            padding: 2px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .card-item.selected .qty-control {
            display: flex;
            animation: popIn 0.2s;
        }

        /* Esconde o checkbox se o controle de quantidade estiver visível */
        .card-item.selected.has-qty .checkbox-circle {
            display: none;
        }

        .btn-qty {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: var(--primary);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-qty:hover {
            background: var(--primary);
            color: white;
        }

        .qty-val {
            font-size: 14px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- CALENDÁRIO --- */
        .calendar-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-card {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background: #FAFAFA;
            transition: 0.2s;
        }

        .day-card.avail .day-status {
            background: var(--status-avail);
        }

        .day-card.busy .day-status {
            background: var(--status-busy);
        }

        .day-card.part .day-status {
            background: var(--status-part);
        }

        .day-card.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .day-card.selected {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .day-card.selected .day-status {
            background: white;
        }

        .day-status {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 4px;
        }

        /* Time Slots */
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 20px;
            border-top: 1px dashed var(--border);
            padding-top: 20px;
        }

        .time-pill {
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: 0.2s;
        }

        .time-pill.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* --- FOOTER E REVISÃO --- */
        .review-box {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .review-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .review-total {
            border-top: 2px dashed var(--border);
            padding-top: 15px;
            margin-top: 10px;
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .btn-next {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-next:disabled {
            background: #E5E7EB;
            color: #9CA3AF;
            cursor: not-allowed;
        }

        .btn-back {
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            margin-top: 5px;
        }

    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="font-size: 20px; font-weight: 700;">Novo Agendamento</h1>
        <p style="font-size: 13px; color: var(--text-muted);">Configure sua experiência</p>
    </div>

    <div class="stepper">
        <div class="step active" id="st-1">
            <div class="step-circle">1</div>
            <span class="step-label">Prof</span></div>
        <div class="step" id="st-2">
            <div class="step-circle">2</div>
            <span class="step-label">Serviço</span></div>
        <div class="step" id="st-3">
            <div class="step-circle">3</div>
            <span class="step-label">Extras</span></div>
        <div class="step" id="st-4">
            <div class="step-circle">4</div>
            <span class="step-label">Data</span></div>
        <div class="step" id="st-5">
            <div class="step-circle">5</div>
            <span class="step-label">Fim</span></div>
    </div>

    <form id="booking-form" onsubmit="event.preventDefault()">

        <div id="step-1" class="fade-in">
            <h2 style="margin-bottom: 15px; font-size: 18px;">Quem vai te atender?</h2>
            <div class="selection-grid" id="prof-list"></div>
        </div>

        <div id="step-2" class="hidden fade-in">
            <h2 style="margin-bottom: 15px; font-size: 18px;">Qual o procedimento?</h2>
            <div class="selection-grid" id="service-list"></div>
        </div>

        <div id="step-3" class="hidden fade-in">
            <h2 style="margin-bottom: 5px; font-size: 18px;">Adicionais?</h2>
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">Selecione itens extras ou
                quantidade de reparos.</p>
            <div class="selection-grid" id="addons-list"></div>
        </div>

        <div id="step-4" class="hidden fade-in">
            <h2 style="margin-bottom: 15px; font-size: 18px;">Escolha o Horário</h2>
            <div class="calendar-container">
                <div class="month-nav">
                    <button type="button" class="nav-btn" onclick="navMonth(-1)">❮</button>
                    <h3 id="month-display">Mês</h3>
                    <button type="button" class="nav-btn" onclick="navMonth(1)">❯</button>
                </div>
                <div class="week-days">
                    <div>D</div>
                    <div>S</div>
                    <div>T</div>
                    <div>Q</div>
                    <div>Q</div>
                    <div>S</div>
                    <div>S</div>
                </div>
                <div class="days-grid" id="calendar-grid"></div>
                <div class="slots-grid hidden" id="time-slots"></div>
            </div>
        </div>

        <div id="step-5" class="hidden fade-in">
            <h2 style="margin-bottom: 15px; font-size: 18px;">Resumo do Pedido</h2>
            <div class="review-box">
                <div class="review-row"><span>Profissional</span> <strong id="rev-prof">...</strong></div>
                <div class="review-row"><span>Serviço</span> <strong id="rev-serv">...</strong></div>
                <div class="review-row"><span>Data</span> <strong id="rev-date">...</strong></div>

                <div id="rev-addons"
                     style="margin: 10px 0; padding: 10px 0; border-top: 1px solid #eee; font-size: 13px; color: #555;"></div>

                <div class="review-total">
                    <span>Total Estimado</span>
                    <span id="rev-total">R$ 0,00</span>
                </div>
            </div>
            <div>
                <label style="font-size: 14px; font-weight: 600;">Observações</label>
                <textarea rows="3" id="obs-input" placeholder="Ex: Alergia a esmalte comum..."></textarea>
            </div>
        </div>
    </form>
</div>

<div class="bottom-bar">
    <button class="btn-back" id="btn-back" onclick="prevStep()" style="visibility: hidden;">Voltar</button>
    <div style="text-align: right;">
        <span style="font-size: 12px; display: block; color: var(--text-muted);">Total: <span id="footer-total"
                                                                                              style="font-weight:700; color:var(--primary)">R$ 0</span></span>
        <button class="btn-next" id="btn-next" onclick="nextStep()" disabled>Continuar</button>
    </div>
</div>

<script>
    /* --- DADOS MOCKADOS (Simulando Backend) --- */
    const professionals = [
        {id: 1, name: "Dra. Ana", role: "Biomédica", initial: "A"},
        {id: 2, name: "Carla S.", role: "Manicure", initial: "C"},
        {id: 3, name: "Beto", role: "Cabeleireiro", initial: "B"}
    ];

    const services = [
        {id: 10, name: "Unha em Gel", price: 120, time: "90min"},
        {id: 11, name: "Spa dos Pés", price: 80, time: "45min"},
        {id: 12, name: "Corte & Escova", price: 150, time: "60min"}
    ];

    const addons = [
        {id: 901, name: "Decoração (Por Dedo)", price: 15, perUnit: true}, // FLAG: Por Unidade
        {id: 902, name: "Conserto de Unha", price: 20, perUnit: true},     // FLAG: Por Unidade
        {id: 903, name: "Massagem nas Mãos", price: 25, perUnit: false},   // Fixo
        {id: 904, name: "Hidratação Cutículas", price: 15, perUnit: false} // Fixo
    ];

    /* --- ESTADO --- */
    let step = 1;
    let booking = {
        professional: null,
        mainService: null,
        addOns: [], // Array de { id, qty, price, name }
        date: null,
        time: null,
        total: 0
    };
    let currentMonth = new Date();

    /* --- INICIALIZAÇÃO --- */
    document.addEventListener("DOMContentLoaded", () => {
        renderProf();
        renderServices();
        renderAddons();
        renderCalendar();
    });

    /* --- RENDERIZADORES --- */
    function renderProf() {
        const el = document.getElementById('prof-list');
        el.innerHTML = professionals.map(p => `
      <div class="card-item" onclick="selectProf(this, ${p.id})">
        <div class="item-left">
          <div class="avatar">${p.initial}</div>
          <div class="item-info"><h3>${p.name}</h3><p>${p.role}</p></div>
        </div>
        <div class="checkbox-circle">✓</div>
      </div>
    `).join('');
    }

    function renderServices() {
        const el = document.getElementById('service-list');
        el.innerHTML = services.map(s => `
      <div class="card-item" onclick="selectService(this, ${s.id})">
        <div class="item-left">
          <div class="item-info"><h3>${s.name}</h3><p>${s.time}</p></div>
        </div>
        <div class="price-tag">R$ ${s.price}</div>
      </div>
    `).join('');
    }

    // --- LÓGICA CORE: RENDERIZAÇÃO INTELIGENTE DOS ADDONS ---
    function renderAddons() {
        const el = document.getElementById('addons-list');
        el.innerHTML = addons.map(a => {
            // Se for item unitário (nailCount=1 no back), usa classe 'has-qty'
            const hasQtyClass = a.perUnit ? 'has-qty' : '';
            const unitLabel = a.perUnit ? '<span style="font-size:10px; font-weight:400; color:#999">/unid</span>' : '';

            return `
      <div class="card-item ${hasQtyClass}" id="addon-card-${a.id}" onclick="toggleAddon(this, ${a.id})">
        <div class="item-left">
          <div class="item-info">
            <h3>${a.name}</h3>
            <p class="price-tag" style="margin:0">+R$ ${a.price} ${unitLabel}</p>
          </div>
        </div>

        <div style="display:flex; align-items:center;">

          <div class="checkbox-circle">✓</div>

          ${a.perUnit ? `
            <div class="qty-control" onclick="event.stopPropagation()">
              <button class="btn-qty" type="button" onclick="changeQty(${a.id}, -1)">-</button>
              <span class="qty-val" id="qty-${a.id}">1</span>
              <button class="btn-qty" type="button" onclick="changeQty(${a.id}, 1)">+</button>
            </div>
          ` : ''}

        </div>
      </div>
    `
        }).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        const display = document.getElementById('month-display');
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        display.innerText = `${months[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        grid.innerHTML = "";

        const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
        const startDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();

        for (let i = 0; i < startDay; i++) grid.innerHTML += `<div></div>`;

        for (let i = 1; i <= daysInMonth; i++) {
            let status = "avail";
            if (i % 7 === 0) status = "busy"; // Mock

            const btn = document.createElement("div");
            btn.className = `day-card ${status}`;
            if (status === 'busy') btn.classList.add('disabled');
            btn.innerHTML = `<span style="font-size:14px; font-weight:600">${i}</span><div class="day-status"></div>`;
            btn.onclick = () => selectDate(btn, i);
            grid.appendChild(btn);
        }
    }

    function navMonth(dir) {
        currentMonth.setMonth(currentMonth.getMonth() + dir);
        renderCalendar();
    }

    /* --- INTERAÇÃO --- */

    function selectProf(el, id) {
        document.querySelectorAll('#prof-list .card-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        booking.professional = professionals.find(p => p.id === id);
        checkValidity();
    }

    function selectService(el, id) {
        document.querySelectorAll('#service-list .card-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        booking.mainService = services.find(s => s.id === id);
        updateTotal();
        checkValidity();
    }

    // --- LÓGICA CORE: TOGGLE ADDON ---
    function toggleAddon(el, id) {
        const addonData = addons.find(a => a.id === id);
        const isSelected = el.classList.contains('selected');

        if (isSelected) {
            // Remover
            el.classList.remove('selected');
            booking.addOns = booking.addOns.filter(item => item.id !== id);
        } else {
            // Adicionar
            el.classList.add('selected');
            // Default qty = 1
            booking.addOns.push({...addonData, qty: 1});

            // Resetar visual do contador para 1 se existir
            const qtyDisplay = document.getElementById(`qty-${id}`);
            if (qtyDisplay) qtyDisplay.innerText = "1";
        }
        updateTotal();
    }

    // --- LÓGICA CORE: MUDAR QUANTIDADE ---
    function changeQty(id, delta) {
        const index = booking.addOns.findIndex(a => a.id === id);
        if (index === -1) return;

        let newQty = booking.addOns[index].qty + delta;
        if (newQty < 1) newQty = 1;  // Mínimo
        if (newQty > 10) newQty = 10; // Máximo (ex: dedos da mão)

        booking.addOns[index].qty = newQty;
        document.getElementById(`qty-${id}`).innerText = newQty;
        updateTotal();
    }

    function selectDate(el, day) {
        document.querySelectorAll('.day-card').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        booking.date = `${day}/${currentMonth.getMonth() + 1}`;

        // Render time slots
        const slotContainer = document.getElementById('time-slots');
        slotContainer.classList.remove('hidden');
        const times = ["09:00", "10:00", "14:00", "16:30"];
        slotContainer.innerHTML = times.map(t => `<div class="time-pill" onclick="selectTime(this, '${t}')">${t}</div>`).join('');
        checkValidity();
    }

    function selectTime(el, t) {
        document.querySelectorAll('.time-pill').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        booking.time = t;
        checkValidity();
    }

    function updateTotal() {
        let t = 0;
        if (booking.mainService) t += booking.mainService.price;
        // Soma: Preço * Quantidade
        booking.addOns.forEach(a => t += (a.price * a.qty));

        booking.total = t;
        document.getElementById('footer-total').innerText = `R$ ${t}`;

        if (step === 5) renderReview();
    }

    /* --- NAVEGAÇÃO --- */
    function checkValidity() {
        let ok = false;
        if (step === 1 && booking.professional) ok = true;
        if (step === 2 && booking.mainService) ok = true;
        if (step === 3) ok = true;
        if (step === 4 && booking.date && booking.time) ok = true;
        if (step === 5) ok = true;
        document.getElementById('btn-next').disabled = !ok;
    }

    function nextStep() {
        if (step === 5) {
            const obs = document.getElementById('obs-input').value;
            alert(`Enviando para API:\nProf: ${booking.professional.name}\nServiço: ${booking.mainService.name}\nExtras: ${JSON.stringify(booking.addOns)}\nObs: ${obs}`);
            return;
        }

        if (step === 4) renderReview(); // Prepara review antes de entrar no passo 5

        document.getElementById(`st-${step}`).classList.remove('active');
        document.getElementById(`st-${step}`).classList.add('completed');
        document.getElementById(`step-${step}`).classList.add('hidden');

        step++;

        document.getElementById(`st-${step}`).classList.add('active');
        document.getElementById(`step-${step}`).classList.remove('hidden');

        updateUI();
        checkValidity();
    }

    function prevStep() {
        document.getElementById(`st-${step}`).classList.remove('active');
        document.getElementById(`step-${step}`).classList.add('hidden');
        step--;
        document.getElementById(`st-${step}`).classList.add('active');
        document.getElementById(`st-${step}`).classList.remove('completed');
        document.getElementById(`step-${step}`).classList.remove('hidden');
        updateUI();
    }

    function updateUI() {
        document.getElementById('btn-back').style.visibility = step === 1 ? 'hidden' : 'visible';
        document.getElementById('btn-next').innerText = step === 5 ? 'Confirmar Agendamento' : 'Continuar';
    }

    function renderReview() {
        document.getElementById('rev-prof').innerText = booking.professional.name;
        document.getElementById('rev-serv').innerText = booking.mainService.name;
        document.getElementById('rev-date').innerText = `${booking.date} às ${booking.time}`;
        document.getElementById('rev-total').innerText = `R$ ${booking.total}`;

        const addonsHTML = booking.addOns.map(a => {
            // Mostra Qtd apenas se for unitário ou qty > 1
            const qtyStr = a.perUnit ? ` <strong>(${a.qty}x)</strong>` : '';
            return `<div style="display:flex; justify-content:space-between; margin-bottom:4px">
                <span>+ ${a.name}${qtyStr}</span>
                <span>R$ ${a.price * a.qty}</span>
              </div>`;
        }).join('');

        document.getElementById('rev-addons').innerHTML = addonsHTML || '<span style="font-style:italic">Sem itens adicionais</span>';
    }

</script>
</body>
</html>